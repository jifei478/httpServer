'use strict';const a48_0x7318c7=a48_0x3d86;(function(_0x173fa8,_0x16342f){const _0x301053=a48_0x3d86,_0x534404=_0x173fa8();while(!![]){try{const _0x453ca0=parseInt(_0x301053(0x1a5))/0x1+parseInt(_0x301053(0x1a6))/0x2*(-parseInt(_0x301053(0x1f0))/0x3)+-parseInt(_0x301053(0x1bd))/0x4*(-parseInt(_0x301053(0x1f9))/0x5)+-parseInt(_0x301053(0x17e))/0x6+parseInt(_0x301053(0x1f5))/0x7+parseInt(_0x301053(0x1a4))/0x8+parseInt(_0x301053(0x1d7))/0x9;if(_0x453ca0===_0x16342f)break;else _0x534404['push'](_0x534404['shift']());}catch(_0x454290){_0x534404['push'](_0x534404['shift']());}}}(a48_0x2b26,0x565a5));function a48_0x3d86(_0x50493e,_0x1fc523){const _0x2b2608=a48_0x2b26();return a48_0x3d86=function(_0x3d86ee,_0xe76e80){_0x3d86ee=_0x3d86ee-0x17a;let _0x281d06=_0x2b2608[_0x3d86ee];return _0x281d06;},a48_0x3d86(_0x50493e,_0x1fc523);}function a48_0x2b26(){const _0x303b06=['flushToMongoDB','forEach','MaxNumber','setex','用户未登录！','Gold','getDefaultUser','2227140cokkOr','NkdPc','bulkWrite','mDPCk','g_tickScheduler','[MongoDB]\x20flushToMongoDB\x20failed','DtZBO','g_dataPool','misc','EquipTpl','expandBag','use','__esModule','[Redis]\x20flushToRedis\x20failed','length','markDirty','parse','registerCtor','testGenerateEquip','TsrpcError','toggleLockEquip','unwearEquip','toJSON','../../../core/manager/dataTree/TreeBuilder','startAutoSaveLoop','417819OUMxTU','root','ilOzQ','user.characterEquip.','../data/user/UserData','3114237hVmVmA','RingRight','sellEquip','checkUser','1025eTuGxo','redis','findOne','✅\x20UserMgr.init()\x20called','Equip','TwoHandAxe','Misc','../data/equip/Equip','EquipType','_children','level','kickUser','3081636DWSPuu','g_config','equipTplId','RingLeft','set','user','build','getChild','g_global','init','user_auto_save_mongo','error','./EquipMgr','nnwCj','UserData','get','entries','REDIS_PREFIX_User','bag','EquipBagData','info','exec','isDirty','BagType','../../../gameConfig/GameConfigMgr','getUpdates','DefaultNumber','Weapon','release','clearDirty','_id','push','MONGODB_WRITE_FREQUENCY','g_gameConfigMgr','Material','EquipSlot','items','iIvls','3539944EqyWto','207018mSuiEv','10MQtgdb','../../../common/Config','materials','gold','getUserNode','g_treeBuilder','BInxX','equip','REDIS_EXPIRE_TIME','flushToRedis','decomposeEquip','user.bag.equip','registerAllDataCtors','wearEquip','aSGSl','split','ZGYvn','getUserData','multi','NYyBN','acquire','SingleBase','PackPackConfig','4328KiXyiR','g_equipMgr','EquipSubType','../../../shared/interface/bag/Bag','UserMgr','slice','user_game_info_col','../../../core/base/SingleBase','AzvdL','tsrpc','../../../utils/Logger','g_logger','yJDLJ','equipReqLevel','GEwpE','../data/equip/CharacterEquipData','stringify','setChild','characterEquip'];a48_0x2b26=function(){return _0x303b06;};return a48_0x2b26();}Object['defineProperty'](exports,a48_0x7318c7(0x1e3),{'value':!![]}),exports[a48_0x7318c7(0x1c1)]=void 0x0;const SingleBase_1=require(a48_0x7318c7(0x1c4)),Global_1=require('../../../common/Global'),Config_1=require(a48_0x7318c7(0x1a7)),TickScheduler_1=require('../../../core/manager/TickScheduler'),DataPool_1=require('../../../core/manager/dataTree/DataPool'),TreeBuilder_1=require(a48_0x7318c7(0x1ee)),Logger_1=require(a48_0x7318c7(0x1c7)),LoadingPool_1=require('../../../core/manager/LoadingPool'),GameConfigMgr_1=require(a48_0x7318c7(0x196)),EquipMgr_1=require(a48_0x7318c7(0x18a)),Equip_1=require('../../../shared/interface/equip/Equip'),Bag_1=require(a48_0x7318c7(0x1c0)),BagData_1=require('../data/bag/BagData'),UserData_1=require(a48_0x7318c7(0x1f4)),tsrpc_1=require(a48_0x7318c7(0x1c6)),Equip_2=require(a48_0x7318c7(0x200)),CharacterEquipData_1=require(a48_0x7318c7(0x1cc)),redisLoadPool=new LoadingPool_1['LoadingPool'](),mongoLoadPool=new LoadingPool_1['LoadingPool']();class UserMgr extends SingleBase_1[a48_0x7318c7(0x1bb)]{constructor(){const _0x18539b=a48_0x7318c7,_0x2b9c03={'lOPgK':'users'};super(...arguments),this['root']=DataPool_1['g_dataPool'][_0x18539b(0x1ba)]({'poolKey':_0x2b9c03['lOPgK'],'path':'','isLeaf':![]});}[a48_0x7318c7(0x187)](){const _0x3de988=a48_0x7318c7,_0x32d273={'ilOzQ':_0x3de988(0x1fc)};Logger_1['g_logger'][_0x3de988(0x192)](_0x32d273[_0x3de988(0x1f2)]),this[_0x3de988(0x1ef)](),this[_0x3de988(0x1b2)]();}[a48_0x7318c7(0x1b2)](){const _0x1c17a0=a48_0x7318c7,_0x3e7be9={'GEwpE':'4|0|3|5|2|1','mkAMP':'user.characterEquip','BInxX':_0x1c17a0(0x1b1),'iIvls':'user.bag'},_0x440964=_0x3e7be9[_0x1c17a0(0x1cb)][_0x1c17a0(0x1b5)]('|');let _0x48a429=0x0;while(!![]){switch(_0x440964[_0x48a429++]){case'0':TreeBuilder_1[_0x1c17a0(0x1ab)][_0x1c17a0(0x1e8)](_0x3e7be9['mkAMP'],CharacterEquipData_1['CharacterEquipData']);continue;case'1':TreeBuilder_1[_0x1c17a0(0x1ab)]['registerCtor']('user.bag.equip.items_array',Equip_2['EquipObjectData']);continue;case'2':TreeBuilder_1['g_treeBuilder']['registerCtor'](_0x3e7be9[_0x1c17a0(0x1ac)],BagData_1[_0x1c17a0(0x191)]);continue;case'3':Object['values'](Equip_1[_0x1c17a0(0x1a1)])[_0x1c17a0(0x1d1)](_0x2c6fa8=>{const _0x2258a8=_0x1c17a0;TreeBuilder_1[_0x2258a8(0x1ab)]['registerCtor'](_0x2258a8(0x1f3)+_0x2c6fa8,Equip_2['EquipObjectData']);});continue;case'4':TreeBuilder_1[_0x1c17a0(0x1ab)][_0x1c17a0(0x1e8)](_0x1c17a0(0x183),UserData_1[_0x1c17a0(0x18c)]);continue;case'5':TreeBuilder_1[_0x1c17a0(0x1ab)][_0x1c17a0(0x1e8)](_0x3e7be9[_0x1c17a0(0x1a3)],BagData_1['BagData']);continue;}break;}}async[a48_0x7318c7(0x1aa)](_0x58740e){const _0x2d4ed2=a48_0x7318c7,_0x20051d={'NYyBN':function(_0x599197,_0x1df952){return _0x599197+_0x1df952;},'aDQpu':_0x2d4ed2(0x183)};let _0x20b26d=this['root'][_0x2d4ed2(0x185)](_0x58740e);if(_0x20b26d)return _0x20b26d;const _0x4bd7ed=_0x20051d[_0x2d4ed2(0x1b9)](Config_1[_0x2d4ed2(0x17f)][_0x2d4ed2(0x18f)],_0x58740e),_0x255107=await redisLoadPool[_0x2d4ed2(0x1e2)](_0x58740e,async()=>{const _0x4335b2=_0x2d4ed2,_0x4facdc=await Global_1[_0x4335b2(0x186)][_0x4335b2(0x1fa)][_0x4335b2(0x18d)](_0x4bd7ed);if(_0x4facdc)return JSON[_0x4335b2(0x1e7)](_0x4facdc);return await mongoLoadPool[_0x4335b2(0x1e2)](_0x58740e,async()=>{const _0x5d0268=_0x4335b2,_0x66040c=await Global_1[_0x5d0268(0x186)][_0x5d0268(0x1c3)][_0x5d0268(0x1fb)]({'uid':_0x58740e})||this[_0x5d0268(0x1d6)](_0x58740e);return _0x66040c;});});return _0x20b26d=TreeBuilder_1[_0x2d4ed2(0x1ab)][_0x2d4ed2(0x184)](_0x20051d['aDQpu'],_0x255107),_0x20b26d[_0x2d4ed2(0x1e6)](),this[_0x2d4ed2(0x1f1)][_0x2d4ed2(0x1ce)](_0x58740e,_0x20b26d),_0x20b26d;}async[a48_0x7318c7(0x1b7)](_0x2475f5){const _0x541733=a48_0x7318c7,_0x525257=await this[_0x541733(0x1aa)](_0x2475f5);return _0x525257[_0x541733(0x1ed)]();}[a48_0x7318c7(0x17d)](_0x3e55b3){const _0x47b7b5=a48_0x7318c7,_0x2ef026=this[_0x47b7b5(0x1f1)][_0x47b7b5(0x185)](_0x3e55b3);_0x2ef026&&(DataPool_1[_0x47b7b5(0x1de)][_0x47b7b5(0x19a)](_0x3e55b3,_0x2ef026),this[_0x47b7b5(0x1f1)]['setChild'](_0x3e55b3,undefined));}[a48_0x7318c7(0x1ef)](){const _0x43dcf7=a48_0x7318c7,_0x483f39={'gDDnO':'user_auto_save_redis','HCsce':_0x43dcf7(0x188)};TickScheduler_1['g_tickScheduler']['register'](_0x483f39['gDDnO'],Config_1['g_config']['REDIS_WRITE_FREQUENCY'],async()=>{const _0x32647f=_0x43dcf7;await this[_0x32647f(0x1af)]();}),TickScheduler_1[_0x43dcf7(0x1db)]['register'](_0x483f39['HCsce'],Config_1[_0x43dcf7(0x17f)][_0x43dcf7(0x19e)],async()=>{const _0x32700b=_0x43dcf7;await this[_0x32700b(0x1d0)]();}),TickScheduler_1[_0x43dcf7(0x1db)]['start']();}async['flushToRedis'](){const _0x147de6=a48_0x7318c7,_0x3952f8={'AzvdL':function(_0x12c430,_0x2059c0){return _0x12c430+_0x2059c0;},'ZGYvn':function(_0x464b39,_0x522a06){return _0x464b39>_0x522a06;}},_0x4d0e01=this['root'][_0x147de6(0x17b)];if(!_0x4d0e01)return;const _0x3ee3bc=Global_1['g_global'][_0x147de6(0x1fa)][_0x147de6(0x1b8)]();for(const [_0x3471c9,_0x1488f6]of Object[_0x147de6(0x18e)](_0x4d0e01)){if(!_0x1488f6[_0x147de6(0x194)]())continue;const _0x121abc=_0x3952f8[_0x147de6(0x1c5)](Config_1[_0x147de6(0x17f)][_0x147de6(0x18f)],_0x3471c9),_0x21ddda=_0x1488f6['toJSON']();delete _0x21ddda[_0x147de6(0x19c)];const _0x5ef825=JSON[_0x147de6(0x1cd)](_0x21ddda);_0x3ee3bc[_0x147de6(0x1d3)](_0x121abc,Config_1[_0x147de6(0x17f)][_0x147de6(0x1ae)],_0x5ef825);}if(_0x3952f8[_0x147de6(0x1b6)](_0x3ee3bc['length'],0x0))try{await _0x3ee3bc[_0x147de6(0x193)]();}catch(_0x3212e6){Logger_1[_0x147de6(0x1c8)]['error'](_0x147de6(0x1e4),_0x3212e6);}}async[a48_0x7318c7(0x1d0)](){const _0xce63b=a48_0x7318c7,_0x299353={'aSGSl':function(_0x51e9ff,_0x42d432){return _0x51e9ff>_0x42d432;},'NkdPc':_0xce63b(0x1dc)},_0xf40ec4=this[_0xce63b(0x1f1)][_0xce63b(0x17b)];if(!_0xf40ec4)return;const _0x9886d8=[],_0x5db413=new Map();for(const [_0x4c966b,_0xd903ac]of Object['entries'](_0xf40ec4)){if(!_0xd903ac[_0xce63b(0x194)]())continue;const _0x484d6d=_0xd903ac[_0xce63b(0x197)]();if(!_0x484d6d)continue;_0x9886d8[_0xce63b(0x19d)]({'updateOne':{'filter':{'uid':_0x4c966b},'update':{'$set':_0x484d6d},'upsert':!![]}}),_0x5db413[_0xce63b(0x182)](_0x4c966b,_0xd903ac);}if(_0x299353[_0xce63b(0x1b4)](_0x9886d8[_0xce63b(0x1e5)],0x0))try{await Global_1[_0xce63b(0x186)][_0xce63b(0x1c3)][_0xce63b(0x1d9)](_0x9886d8);for(const [_0x543ec1,_0x4aab9f]of _0x5db413[_0xce63b(0x18e)]()){_0x4aab9f[_0xce63b(0x19b)]();}}catch(_0x1497af){Logger_1[_0xce63b(0x1c8)][_0xce63b(0x189)](_0x299353[_0xce63b(0x1d8)],_0x1497af);}}['getDefaultUser'](_0x49b041){const _0x5d2aef=a48_0x7318c7,_0x46a403={'yJDLJ':function(_0x5c2055,_0x5dc504){return _0x5c2055+_0x5dc504;},'DtZBO':function(_0x22a718,_0x3d597c){return _0x22a718<_0x3d597c;},'nnwCj':function(_0x47d8f6,_0x1dbd79){return _0x47d8f6>_0x1dbd79;},'mDPCk':function(_0x4b3914,_0x506bb8){return _0x4b3914===_0x506bb8;}},_0x451e80=GameConfigMgr_1[_0x5d2aef(0x19f)][_0x5d2aef(0x1bc)],_0x14d241=Object['values'](Bag_1['BagType'])['filter'](_0x254b25=>typeof _0x254b25==='number'),_0x1680a1={};_0x14d241[_0x5d2aef(0x1d1)](_0x18729d=>{const _0x4df811=_0x5d2aef;switch(_0x18729d){case Bag_1[_0x4df811(0x195)][_0x4df811(0x1fd)]:_0x1680a1[_0x4df811(0x1ad)]={'basicInfo':{'type':_0x18729d,'currentNumber':_0x451e80[Bag_1[_0x4df811(0x195)][_0x4df811(0x1fd)]]['DefaultNumber'],'maxNumber':_0x451e80[Bag_1['BagType'][_0x4df811(0x1fd)]][_0x4df811(0x1d2)],'expandTimes':0x0},'items':[]};break;case Bag_1[_0x4df811(0x195)]['Material']:_0x1680a1[_0x4df811(0x1a8)]={'basicInfo':{'type':_0x18729d,'currentNumber':_0x451e80[Bag_1[_0x4df811(0x195)]['Material']][_0x4df811(0x198)],'maxNumber':_0x451e80[Bag_1[_0x4df811(0x195)][_0x4df811(0x1a0)]][_0x4df811(0x1d2)],'expandTimes':0x0},'items':[]};break;case Bag_1[_0x4df811(0x195)][_0x4df811(0x1ff)]:_0x1680a1[_0x4df811(0x1df)]={'basicInfo':{'type':_0x18729d,'currentNumber':_0x451e80[Bag_1[_0x4df811(0x195)]['Misc']][_0x4df811(0x198)],'maxNumber':_0x451e80[Bag_1['BagType'][_0x4df811(0x1ff)]][_0x4df811(0x1d2)],'expandTimes':0x0},'items':[]};break;case Bag_1[_0x4df811(0x195)][_0x4df811(0x1d5)]:_0x1680a1[_0x4df811(0x1a9)]=0x0;break;default:break;}});const _0x4b4c19={'uid':_0x49b041,'nickname':_0x46a403[_0x5d2aef(0x1c9)]('游客',_0x49b041[_0x5d2aef(0x1c2)](-0x4)),'level':0x1,'exp':0x0,'characterEquip':{},'bag':_0x1680a1};for(let _0x2e9e36=0x0;_0x46a403[_0x5d2aef(0x1dd)](_0x2e9e36,0xa);++_0x2e9e36){const _0x45945e=EquipMgr_1[_0x5d2aef(0x1be)][_0x5d2aef(0x1e9)]();if(_0x45945e&&_0x46a403[_0x5d2aef(0x18b)](_0x45945e[_0x5d2aef(0x1ca)],_0x4b4c19[_0x5d2aef(0x17c)])){const _0x2b6b91={..._0x45945e};_0x4b4c19[_0x5d2aef(0x190)]['equip'][_0x5d2aef(0x1a2)]['push'](_0x2b6b91);continue;}const _0x25c0ea=GameConfigMgr_1[_0x5d2aef(0x19f)][_0x5d2aef(0x1e0)][_0x45945e[_0x5d2aef(0x180)]],_0x416ae0=_0x25c0ea[_0x5d2aef(0x17a)];let _0x5216d1=EquipMgr_1[_0x5d2aef(0x1be)]['getEquipSlotByType'](_0x416ae0);_0x46a403[_0x5d2aef(0x1da)](_0x5216d1,Equip_1[_0x5d2aef(0x1a1)][_0x5d2aef(0x181)])&&_0x4b4c19['characterEquip'][_0x5216d1]&&(_0x5216d1=Equip_1[_0x5d2aef(0x1a1)][_0x5d2aef(0x1f6)]);(_0x416ae0===Equip_1[_0x5d2aef(0x1bf)][_0x5d2aef(0x1fe)]||_0x46a403[_0x5d2aef(0x1da)](_0x416ae0,Equip_1[_0x5d2aef(0x1bf)]['TwoHandSword']))&&(_0x5216d1=Equip_1[_0x5d2aef(0x1a1)][_0x5d2aef(0x199)]);const _0x3db928=_0x4b4c19['characterEquip'][_0x5216d1];if(_0x3db928){const _0x56216b={..._0x45945e};_0x4b4c19[_0x5d2aef(0x190)][_0x5d2aef(0x1ad)][_0x5d2aef(0x1a2)][_0x5d2aef(0x19d)](_0x56216b);continue;}_0x45945e&&_0x45945e[_0x5d2aef(0x1ca)]<=_0x4b4c19[_0x5d2aef(0x17c)]&&(_0x4b4c19[_0x5d2aef(0x1cf)][_0x5216d1]=_0x45945e);}return _0x4b4c19;}[a48_0x7318c7(0x1f8)](_0x1b5339){const _0x3ce31f=a48_0x7318c7;let _0x4f0fc8=this[_0x3ce31f(0x1f1)]['getChild'](_0x1b5339);if(!_0x4f0fc8)throw new tsrpc_1[(_0x3ce31f(0x1ea))](_0x3ce31f(0x1d4));return _0x4f0fc8;}['wearEquip'](_0x4cb624,_0x2a92b6){const _0x1a3310=a48_0x7318c7;let _0x17ebf0=this[_0x1a3310(0x1f8)](_0x4cb624);return _0x17ebf0[_0x1a3310(0x1b3)](_0x2a92b6);}[a48_0x7318c7(0x1ec)](_0x4e885f,_0x197505){const _0x4ab138=a48_0x7318c7;let _0x3467dd=this[_0x4ab138(0x1f8)](_0x4e885f);return _0x3467dd[_0x4ab138(0x1ec)](_0x197505,!![]);}[a48_0x7318c7(0x1b0)](_0xbb493a,_0x49025){let _0x2593fd=this['checkUser'](_0xbb493a);return _0x2593fd['decomposeEquip'](_0x49025);}[a48_0x7318c7(0x1f7)](_0xdb8414,_0x5c9a11){const _0x3215e0=a48_0x7318c7;let _0xa63224=this[_0x3215e0(0x1f8)](_0xdb8414);return{'item':{'id':0x1,'count':_0xa63224[_0x3215e0(0x1f7)](_0x5c9a11)}};}[a48_0x7318c7(0x1eb)](_0x2814d2,_0x20ce7){const _0x10860f=a48_0x7318c7;let _0x472d5=this[_0x10860f(0x1f8)](_0x2814d2);return{'equipId':_0x20ce7,'isLocked':_0x472d5['toggleLockEquip'](_0x20ce7)};}[a48_0x7318c7(0x1e1)](_0x560e4c,_0x43a762){const _0x33a9b5=a48_0x7318c7;let _0x54ec77=this[_0x33a9b5(0x1f8)](_0x560e4c);return _0x54ec77[_0x33a9b5(0x1e1)](_0x43a762);}}exports[a48_0x7318c7(0x1c1)]=UserMgr;