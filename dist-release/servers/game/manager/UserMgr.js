'use strict';function a48_0x5743(){const _0x3fe176=['length','toJSON','root','bBPDP','_children','g_treeBuilder','user.bag','obseY','2XNQNpQ','items','multi','15gvCtRT','tsrpc','user','UserData','flushToMongoDB','setChild','EquipBagData','materials','../../../utils/Logger','slice','../../../shared/interface/bag/Bag','checkUser','expandBag','../../../common/Global','../../../core/manager/dataTree/DataPool','testGenerateEquip','kickUser','../../../common/Config','info','用户未登录！','CharacterEquipData','11512jWnsKw','../../../core/manager/LoadingPool','672024uQHNCL','number','SingleBase','DefaultNumber','entries','eyIlU','UserMgr','Gold','parse','FGYUC','register','g_gameConfigMgr','../../../core/manager/dataTree/TreeBuilder','startAutoSaveLoop','findOne','markDirty','redis','build','../../../shared/interface/equip/Equip','user_auto_save_redis','EquipSlot','clearDirty','forEach','equip','EquipObjectData','user.bag.equip','g_global','user_auto_save_mongo','g_logger','171ArXcZG','REDIS_EXPIRE_TIME','start','equipReqLevel','rVwWi','173055WKkLcr','Equip','setex','✅\x20UserMgr.init()\x20called','get','0|3|2|1|4|5','level','user.characterEquip.','getChild','TCuwK','5325590updcjQ','sellEquip','flushToRedis','g_equipMgr','decomposeEquip','LoadingPool','TwoHandAxe','isDirty','push','REDIS_PREFIX_User','TsrpcError','registerAllDataCtors','126755ZUkGoT','TwoHandSword','wearEquip','../../../gameConfig/GameConfigMgr','EquipTpl','bulkWrite','gold','MaxNumber','init','filter','registerCtor','bag','1570751xqgGHm','g_config','use','acquire','EquipSubType','getDefaultUser','user.bag.equip.items_array','error','[MongoDB]\x20flushToMongoDB\x20failed','g_tickScheduler','set','unwearEquip','Misc','../data/bag/BagData','Naqbc','Material','g_dataPool','split','RingRight','sXLKg','misc','46364WWDYqZ','EquipType','../data/user/UserData','characterEquip','../data/equip/Equip','Dbfse','RingLeft','_id','BagType','ZQleM','exec','toggleLockEquip','MONGODB_WRITE_FREQUENCY','BagData','equipTplId','stringify','getUserData','JNvct','getUserNode'];a48_0x5743=function(){return _0x3fe176;};return a48_0x5743();}const a48_0x21eb33=a48_0xbf66;function a48_0xbf66(_0x38b054,_0x3650a0){const _0x5743cf=a48_0x5743();return a48_0xbf66=function(_0xbf6647,_0x576f9){_0xbf6647=_0xbf6647-0x14e;let _0x53ac08=_0x5743cf[_0xbf6647];return _0x53ac08;},a48_0xbf66(_0x38b054,_0x3650a0);}(function(_0x105cd4,_0x427bff){const _0xdb5b0b=a48_0xbf66,_0x47cc13=_0x105cd4();while(!![]){try{const _0x71bf6=parseInt(_0xdb5b0b(0x17f))/0x1*(-parseInt(_0xdb5b0b(0x1bb))/0x2)+parseInt(_0xdb5b0b(0x169))/0x3+-parseInt(_0xdb5b0b(0x1a0))/0x4*(parseInt(_0xdb5b0b(0x1be))/0x5)+-parseInt(_0xdb5b0b(0x1d5))/0x6+-parseInt(_0xdb5b0b(0x18b))/0x7+parseInt(_0xdb5b0b(0x1d3))/0x8*(parseInt(_0xdb5b0b(0x164))/0x9)+parseInt(_0xdb5b0b(0x173))/0xa;if(_0x71bf6===_0x427bff)break;else _0x47cc13['push'](_0x47cc13['shift']());}catch(_0x104698){_0x47cc13['push'](_0x47cc13['shift']());}}}(a48_0x5743,0x1d36c));Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['UserMgr']=void 0x0;const SingleBase_1=require('../../../core/base/SingleBase'),Global_1=require(a48_0x21eb33(0x1cb)),Config_1=require(a48_0x21eb33(0x1cf)),TickScheduler_1=require('../../../core/manager/TickScheduler'),DataPool_1=require(a48_0x21eb33(0x1cc)),TreeBuilder_1=require(a48_0x21eb33(0x153)),Logger_1=require(a48_0x21eb33(0x1c6)),LoadingPool_1=require(a48_0x21eb33(0x1d4)),GameConfigMgr_1=require(a48_0x21eb33(0x182)),EquipMgr_1=require('./EquipMgr'),Equip_1=require(a48_0x21eb33(0x159)),Bag_1=require(a48_0x21eb33(0x1c8)),BagData_1=require(a48_0x21eb33(0x198)),UserData_1=require(a48_0x21eb33(0x1a2)),tsrpc_1=require(a48_0x21eb33(0x1bf)),Equip_2=require(a48_0x21eb33(0x1a4)),CharacterEquipData_1=require('../data/equip/CharacterEquipData'),redisLoadPool=new LoadingPool_1['LoadingPool'](),mongoLoadPool=new LoadingPool_1[(a48_0x21eb33(0x178))]();class UserMgr extends SingleBase_1[a48_0x21eb33(0x1d7)]{constructor(){const _0x323c99=a48_0x21eb33,_0x88a16d={'PIDUC':'users'};super(...arguments),this[_0x323c99(0x1b5)]=DataPool_1['g_dataPool'][_0x323c99(0x18e)]({'poolKey':_0x88a16d['PIDUC'],'path':'','isLeaf':![]});}[a48_0x21eb33(0x187)](){const _0x3205af=a48_0x21eb33,_0x555e68={'rVwWi':_0x3205af(0x16c)};Logger_1[_0x3205af(0x163)][_0x3205af(0x1d0)](_0x555e68[_0x3205af(0x168)]),this[_0x3205af(0x154)](),this[_0x3205af(0x17e)]();}[a48_0x21eb33(0x17e)](){const _0xbedcaf=a48_0x21eb33,_0x22083f={'eyIlU':_0xbedcaf(0x1b9),'Naqbc':'user.characterEquip','JNvct':_0xbedcaf(0x160)},_0x26934d=_0xbedcaf(0x16e)[_0xbedcaf(0x19c)]('|');let _0x52921c=0x0;while(!![]){switch(_0x26934d[_0x52921c++]){case'0':TreeBuilder_1[_0xbedcaf(0x1b8)][_0xbedcaf(0x189)](_0xbedcaf(0x1c0),UserData_1[_0xbedcaf(0x1c1)]);continue;case'1':TreeBuilder_1['g_treeBuilder']['registerCtor'](_0x22083f[_0xbedcaf(0x1da)],BagData_1[_0xbedcaf(0x1ad)]);continue;case'2':Object['values'](Equip_1[_0xbedcaf(0x15b)])[_0xbedcaf(0x15d)](_0x348657=>{const _0x2ae856=_0xbedcaf;TreeBuilder_1['g_treeBuilder'][_0x2ae856(0x189)](_0x2ae856(0x170)+_0x348657,Equip_2[_0x2ae856(0x15f)]);});continue;case'3':TreeBuilder_1[_0xbedcaf(0x1b8)][_0xbedcaf(0x189)](_0x22083f[_0xbedcaf(0x199)],CharacterEquipData_1[_0xbedcaf(0x1d2)]);continue;case'4':TreeBuilder_1[_0xbedcaf(0x1b8)]['registerCtor'](_0x22083f[_0xbedcaf(0x1b1)],BagData_1[_0xbedcaf(0x1c4)]);continue;case'5':TreeBuilder_1[_0xbedcaf(0x1b8)][_0xbedcaf(0x189)](_0xbedcaf(0x191),Equip_2['EquipObjectData']);continue;}break;}}async[a48_0x21eb33(0x1b2)](_0x308400){const _0x3c240c=a48_0x21eb33,_0x52d6b0={'bBPDP':function(_0x555968,_0x55665f){return _0x555968+_0x55665f;}};let _0x4e3ec6=this[_0x3c240c(0x1b5)][_0x3c240c(0x171)](_0x308400);if(_0x4e3ec6)return _0x4e3ec6;const _0xafb808=_0x52d6b0[_0x3c240c(0x1b6)](Config_1[_0x3c240c(0x18c)][_0x3c240c(0x17c)],_0x308400),_0x16b87d=await redisLoadPool['use'](_0x308400,async()=>{const _0x27b506=_0x3c240c,_0x1a3971=await Global_1[_0x27b506(0x161)][_0x27b506(0x157)][_0x27b506(0x16d)](_0xafb808);if(_0x1a3971)return JSON[_0x27b506(0x14f)](_0x1a3971);return await mongoLoadPool[_0x27b506(0x18d)](_0x308400,async()=>{const _0x5810fe=_0x27b506,_0x1734f6=await Global_1[_0x5810fe(0x161)]['user_game_info_col'][_0x5810fe(0x155)]({'uid':_0x308400})||this[_0x5810fe(0x190)](_0x308400);return _0x1734f6;});});return _0x4e3ec6=TreeBuilder_1[_0x3c240c(0x1b8)][_0x3c240c(0x158)](_0x3c240c(0x1c0),_0x16b87d),_0x4e3ec6[_0x3c240c(0x156)](),this[_0x3c240c(0x1b5)][_0x3c240c(0x1c3)](_0x308400,_0x4e3ec6),_0x4e3ec6;}async[a48_0x21eb33(0x1b0)](_0xca2673){const _0x248474=a48_0x21eb33,_0x1118f6=await this[_0x248474(0x1b2)](_0xca2673);return _0x1118f6[_0x248474(0x1b4)]();}[a48_0x21eb33(0x1ce)](_0x12b231){const _0x479763=a48_0x21eb33,_0x40ca68=this[_0x479763(0x1b5)]['getChild'](_0x12b231);_0x40ca68&&(DataPool_1[_0x479763(0x19b)]['release'](_0x12b231,_0x40ca68),this[_0x479763(0x1b5)][_0x479763(0x1c3)](_0x12b231,undefined));}['startAutoSaveLoop'](){const _0x2cafa1=a48_0x21eb33;TickScheduler_1['g_tickScheduler'][_0x2cafa1(0x151)](_0x2cafa1(0x15a),Config_1['g_config']['REDIS_WRITE_FREQUENCY'],async()=>{const _0x260809=_0x2cafa1;await this[_0x260809(0x175)]();}),TickScheduler_1['g_tickScheduler']['register'](_0x2cafa1(0x162),Config_1[_0x2cafa1(0x18c)][_0x2cafa1(0x1ac)],async()=>{const _0x1635f3=_0x2cafa1;await this[_0x1635f3(0x1c2)]();}),TickScheduler_1[_0x2cafa1(0x194)][_0x2cafa1(0x166)]();}async[a48_0x21eb33(0x175)](){const _0x17546c=a48_0x21eb33,_0x14a3a0={'FGYUC':function(_0x2cf827,_0x28ec51){return _0x2cf827+_0x28ec51;},'ZQleM':function(_0x3d70a7,_0x42a719){return _0x3d70a7>_0x42a719;}},_0x1e7801=this[_0x17546c(0x1b5)][_0x17546c(0x1b7)];if(!_0x1e7801)return;const _0x369d4c=Global_1[_0x17546c(0x161)]['redis'][_0x17546c(0x1bd)]();for(const [_0x4474f4,_0x3f7a5b]of Object[_0x17546c(0x1d9)](_0x1e7801)){if(!_0x3f7a5b['isDirty']())continue;const _0x58ab3b=_0x14a3a0[_0x17546c(0x150)](Config_1['g_config'][_0x17546c(0x17c)],_0x4474f4),_0x474fe0=_0x3f7a5b['toJSON']();delete _0x474fe0[_0x17546c(0x1a7)];const _0x5a4173=JSON[_0x17546c(0x1af)](_0x474fe0);_0x369d4c[_0x17546c(0x16b)](_0x58ab3b,Config_1['g_config'][_0x17546c(0x165)],_0x5a4173);}if(_0x14a3a0[_0x17546c(0x1a9)](_0x369d4c['length'],0x0))try{await _0x369d4c[_0x17546c(0x1aa)]();}catch(_0x88dc4){Logger_1[_0x17546c(0x163)]['error']('[Redis]\x20flushToRedis\x20failed',_0x88dc4);}}async['flushToMongoDB'](){const _0x22d0fa=a48_0x21eb33,_0x17c84e={'sXLKg':_0x22d0fa(0x1b7)},_0x3605b4=this['root'][_0x17c84e[_0x22d0fa(0x19e)]];if(!_0x3605b4)return;const _0x50928d=[],_0x4d0f9a=new Map();for(const [_0x4ce85f,_0x212afa]of Object[_0x22d0fa(0x1d9)](_0x3605b4)){if(!_0x212afa[_0x22d0fa(0x17a)]())continue;const _0x247189=_0x212afa['getUpdates']();if(!_0x247189)continue;_0x50928d['push']({'updateOne':{'filter':{'uid':_0x4ce85f},'update':{'$set':_0x247189},'upsert':!![]}}),_0x4d0f9a[_0x22d0fa(0x195)](_0x4ce85f,_0x212afa);}if(_0x50928d[_0x22d0fa(0x1b3)]>0x0)try{await Global_1['g_global']['user_game_info_col'][_0x22d0fa(0x184)](_0x50928d);for(const [_0x317c0c,_0x5c94a7]of _0x4d0f9a[_0x22d0fa(0x1d9)]()){_0x5c94a7[_0x22d0fa(0x15c)]();}}catch(_0x2817e1){Logger_1[_0x22d0fa(0x163)][_0x22d0fa(0x192)](_0x22d0fa(0x193),_0x2817e1);}}['getDefaultUser'](_0x4db776){const _0x53d1c9=a48_0x21eb33,_0x43c96c={'obseY':function(_0x2750e0,_0x4abad4){return _0x2750e0<_0x4abad4;},'Dbfse':function(_0x2e81df,_0x4e5457){return _0x2e81df>_0x4e5457;},'TCuwK':function(_0xd9b469,_0x4e341f){return _0xd9b469===_0x4e341f;},'yzGOP':function(_0x12df0a,_0x24e3eb){return _0x12df0a<=_0x24e3eb;}},_0x2581a6=GameConfigMgr_1[_0x53d1c9(0x152)]['PackPackConfig'],_0x26feb2=Object['values'](Bag_1[_0x53d1c9(0x1a8)])[_0x53d1c9(0x188)](_0x79ee32=>typeof _0x79ee32===_0x53d1c9(0x1d6)),_0x54ec4a={};_0x26feb2['forEach'](_0x35bc99=>{const _0x3b9fa8=_0x53d1c9;switch(_0x35bc99){case Bag_1[_0x3b9fa8(0x1a8)][_0x3b9fa8(0x16a)]:_0x54ec4a['equip']={'basicInfo':{'type':_0x35bc99,'currentNumber':_0x2581a6[Bag_1['BagType'][_0x3b9fa8(0x16a)]][_0x3b9fa8(0x1d8)],'maxNumber':_0x2581a6[Bag_1[_0x3b9fa8(0x1a8)][_0x3b9fa8(0x16a)]][_0x3b9fa8(0x186)],'expandTimes':0x0},'items':[]};break;case Bag_1[_0x3b9fa8(0x1a8)][_0x3b9fa8(0x19a)]:_0x54ec4a[_0x3b9fa8(0x1c5)]={'basicInfo':{'type':_0x35bc99,'currentNumber':_0x2581a6[Bag_1[_0x3b9fa8(0x1a8)][_0x3b9fa8(0x19a)]]['DefaultNumber'],'maxNumber':_0x2581a6[Bag_1['BagType'][_0x3b9fa8(0x19a)]][_0x3b9fa8(0x186)],'expandTimes':0x0},'items':[]};break;case Bag_1[_0x3b9fa8(0x1a8)]['Misc']:_0x54ec4a[_0x3b9fa8(0x19f)]={'basicInfo':{'type':_0x35bc99,'currentNumber':_0x2581a6[Bag_1[_0x3b9fa8(0x1a8)][_0x3b9fa8(0x197)]][_0x3b9fa8(0x1d8)],'maxNumber':_0x2581a6[Bag_1[_0x3b9fa8(0x1a8)][_0x3b9fa8(0x197)]][_0x3b9fa8(0x186)],'expandTimes':0x0},'items':[]};break;case Bag_1['BagType'][_0x3b9fa8(0x14e)]:_0x54ec4a[_0x3b9fa8(0x185)]=0x0;break;default:break;}});const _0x57907b={'uid':_0x4db776,'nickname':'游客'+_0x4db776[_0x53d1c9(0x1c7)](-0x4),'level':0x1,'exp':0x0,'characterEquip':{},'bag':_0x54ec4a};for(let _0x267d35=0x0;_0x43c96c[_0x53d1c9(0x1ba)](_0x267d35,0xa);++_0x267d35){const _0x4eb43d=EquipMgr_1[_0x53d1c9(0x176)][_0x53d1c9(0x1cd)]();if(_0x4eb43d&&_0x43c96c[_0x53d1c9(0x1a5)](_0x4eb43d[_0x53d1c9(0x167)],_0x57907b['level'])){const _0x2da27e={..._0x4eb43d};_0x57907b['bag'][_0x53d1c9(0x15e)][_0x53d1c9(0x1bc)]['push'](_0x2da27e);continue;}const _0xbcfd25=GameConfigMgr_1[_0x53d1c9(0x152)][_0x53d1c9(0x183)][_0x4eb43d[_0x53d1c9(0x1ae)]],_0x3ac8d5=_0xbcfd25[_0x53d1c9(0x1a1)];let _0x14f0d1=EquipMgr_1['g_equipMgr']['getEquipSlotByType'](_0x3ac8d5);_0x43c96c[_0x53d1c9(0x172)](_0x14f0d1,Equip_1[_0x53d1c9(0x15b)][_0x53d1c9(0x1a6)])&&_0x57907b[_0x53d1c9(0x1a3)][_0x14f0d1]&&(_0x14f0d1=Equip_1[_0x53d1c9(0x15b)][_0x53d1c9(0x19d)]);(_0x3ac8d5===Equip_1[_0x53d1c9(0x18f)][_0x53d1c9(0x179)]||_0x43c96c[_0x53d1c9(0x172)](_0x3ac8d5,Equip_1[_0x53d1c9(0x18f)][_0x53d1c9(0x180)]))&&(_0x14f0d1=Equip_1[_0x53d1c9(0x15b)]['Weapon']);const _0x5b58d0=_0x57907b[_0x53d1c9(0x1a3)][_0x14f0d1];if(_0x5b58d0){const _0x483222={..._0x4eb43d};_0x57907b[_0x53d1c9(0x18a)][_0x53d1c9(0x15e)][_0x53d1c9(0x1bc)][_0x53d1c9(0x17b)](_0x483222);continue;}_0x4eb43d&&_0x43c96c['yzGOP'](_0x4eb43d['equipReqLevel'],_0x57907b[_0x53d1c9(0x16f)])&&(_0x57907b[_0x53d1c9(0x1a3)][_0x14f0d1]=_0x4eb43d);}return _0x57907b;}[a48_0x21eb33(0x1c9)](_0x29dce0){const _0x4826b7=a48_0x21eb33;let _0x3fda46=this['root'][_0x4826b7(0x171)](_0x29dce0);if(!_0x3fda46)throw new tsrpc_1[(_0x4826b7(0x17d))](_0x4826b7(0x1d1));return _0x3fda46;}[a48_0x21eb33(0x181)](_0x44c69b,_0x23909b){const _0x4c6185=a48_0x21eb33;let _0x3d8017=this[_0x4c6185(0x1c9)](_0x44c69b);return _0x3d8017['wearEquip'](_0x23909b);}[a48_0x21eb33(0x196)](_0x1f22dd,_0x1199ae){const _0x2690eb=a48_0x21eb33;let _0x39380f=this['checkUser'](_0x1f22dd);return _0x39380f[_0x2690eb(0x196)](_0x1199ae,!![]);}['decomposeEquip'](_0x219dc2,_0x1d84f0){const _0x186c94=a48_0x21eb33;let _0x1a9907=this[_0x186c94(0x1c9)](_0x219dc2);return _0x1a9907[_0x186c94(0x177)](_0x1d84f0);}[a48_0x21eb33(0x174)](_0x47c3e7,_0xc18fce){const _0x21c76c=a48_0x21eb33;let _0x386f80=this[_0x21c76c(0x1c9)](_0x47c3e7);return{'item':{'id':0x1,'count':_0x386f80['sellEquip'](_0xc18fce)}};}[a48_0x21eb33(0x1ab)](_0x5e0ea0,_0x4191b5){const _0x4fe440=a48_0x21eb33;let _0x39cfdc=this[_0x4fe440(0x1c9)](_0x5e0ea0);return{'equipId':_0x4191b5,'isLocked':_0x39cfdc[_0x4fe440(0x1ab)](_0x4191b5)};}['expandBag'](_0x3b54da,_0x18e330){const _0x158a80=a48_0x21eb33;let _0x3d186a=this[_0x158a80(0x1c9)](_0x3b54da);return _0x3d186a[_0x158a80(0x1ca)](_0x18e330);}}exports[a48_0x21eb33(0x1db)]=UserMgr;